<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>spoor — idea 2c: all states</title>
    <style>
/* ── Reset & Variables ─────────────────────────────────────── */

*, *::before, *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --bg: #e8e5e0;
    --bg-card: #f2f0ec;
    --bg-hover: #dbd8d3;
    --text: #1e1e1e;
    --text-secondary: #1e1e1eaa;
    --text-muted: #1e1e1e66;
    --border: #1e1e1e;
    --border-light: #1e1e1e33;
    --border-dashed: #1e1e1e22;
    --amber: #b06a28;
    --sage: #5a7a52;
    --blue: #4a6a9a;
    --empty-gray: #8a8a8a;
}

body {
    font-family: system-ui, -apple-system, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    min-height: 100dvh;
}

.label {
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
}

.label-slash {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-right: 0.125rem;
}

/* ── Layout ────────────────────────────────────────────────── */

main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    padding-bottom: 6rem;
}

header {
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
}

header h1 {
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: 0.04em;
}

.tagline {
    font-size: 0.75rem;
    color: var(--text-muted);
    letter-spacing: 0.02em;
}

/* ── Command Bar ───────────────────────────────────────────── */

.command-bar {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0 1.5rem;
    align-items: start;
}

/* ── Drop Zone ─────────────────────────────────────────────── */

.drop-zone {
    width: 160px;
    height: 120px;
    position: relative;
    grid-row: 1 / 2;
    overflow: hidden;
}

.drop-zone-inner {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    border: 1.5px dashed var(--border-light);
    background: transparent;
    cursor: pointer;
    transition:
        top 0.6s cubic-bezier(0.4, 0, 0.2, 1),
        right 0.6s cubic-bezier(0.4, 0, 0.2, 1),
        bottom 0.6s cubic-bezier(0.4, 0, 0.2, 1),
        left 0.6s cubic-bezier(0.4, 0, 0.2, 1),
        background 0.6s cubic-bezier(0.4, 0, 0.2, 1),
        border-color 0.4s ease;
}

.drop-zone-inner:hover {
    border-color: var(--amber);
}

.drop-zone.processing .drop-zone-inner {
    top: calc(50% - 5px);
    right: calc(50% - 5px);
    bottom: calc(50% - 5px);
    left: calc(50% - 5px);
    background: var(--text);
    border-color: transparent;
    cursor: default;
}

.drop-zone-text {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity 0.3s ease;
    z-index: 1;
}

.drop-zone-text.hidden {
    opacity: 0;
    pointer-events: none;
}

.drop-zone-primary {
    font-size: 0.75rem;
    color: var(--text-secondary);
    padding: 0 0.75rem;
}

.drop-zone-secondary {
    font-size: 0.65rem;
    color: var(--text-muted);
    margin-top: 0.2rem;
}

@keyframes core-pulse {
    0%, 100% { transform: scale(1); opacity: 0.6; }
    50% { transform: scale(1.4); opacity: 1; }
}

.drop-zone-inner.pulsing {
    animation: core-pulse 1.5s ease-in-out infinite;
}

/* ── Convergence Particles ─────────────────────────────────── */

.convergence-container {
    position: absolute;
    inset: 0;
    pointer-events: none;
}

.particle {
    position: absolute;
    left: calc(50% - 1.5px);
    top: calc(50% - 1.5px);
    width: 3px;
    height: 3px;
    background: var(--text);
    opacity: 0;
}

@keyframes converge {
    0% {
        transform: translate(var(--sx), var(--sy));
        opacity: 0;
    }
    12% {
        opacity: 0.6;
    }
    75% {
        opacity: 0.4;
    }
    100% {
        transform: translate(0, 0);
        opacity: 0;
    }
}

.convergence-container.active .particle {
    animation: converge var(--dur) ease-in infinite;
    animation-delay: var(--delay);
}

.convergence-container {
    transition: opacity 0.4s ease;
}

.convergence-container.fading {
    opacity: 0;
}

/* ── Right Side (stacked controls + status) ───────────────── */

.right-stack {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    padding: 0.15rem 0;
}

/* ── Controls Row ──────────────────────────────────────────── */

.controls-row {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    flex-wrap: wrap;
}

.control-group {
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

.toggle-label { color: var(--text-muted); }

.toggle-btn {
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    padding: 0.2rem 0.55rem;
    border: 1px solid var(--border-light);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.12s;
}

.toggle-btn:hover { color: var(--text); border-color: var(--text-secondary); }
.toggle-btn.active { background: var(--text); color: var(--bg); border-color: var(--text); }

.confidence-slider { width: 80px; accent-color: var(--amber); height: 2px; }
.confidence-value {
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    min-width: 2em;
    font-variant-numeric: tabular-nums;
}

/* ── Status Section (stacked, cancel inline) ──────────────── */

.status-section {
    opacity: 0;
    transition: opacity 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
}

.status-section.visible { opacity: 1; }

.status-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.1rem;
}

.status-text {
    font-size: 0.7rem;
    color: var(--text-secondary);
    letter-spacing: 0.02em;
    font-variant-numeric: tabular-nums;
}

.cancel-btn {
    font-size: 0.65rem;
    font-weight: 500;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    padding: 0.15rem 0.5rem;
    border: 1px solid var(--border-light);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
}

.cancel-btn:hover { border-color: #b44; color: #b44; }
.cancel-btn.hidden { display: none; }

.count-row {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.7rem;
    color: var(--text-muted);
    letter-spacing: 0.02em;
    line-height: 1.3;
}

.count-marker {
    width: 5px;
    height: 5px;
    flex-shrink: 0;
}

.count-marker.animal { background: var(--sage); }
.count-marker.person { background: var(--blue); }
.count-marker.vehicle { background: var(--amber); }
.count-marker.empty { background: var(--empty-gray); opacity: 0.5; }

.count-num {
    font-variant-numeric: tabular-nums;
}

/* ── Results Header ────────────────────────────────────────── */

.results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 1.25rem;
    padding: 0.6rem 0;
    border-bottom: 1px solid var(--border);
}

.results-summary {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

/* ── Placeholder Cards ─────────────────────────────────────── */

.results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 0.75rem;
    margin-top: 0.75rem;
}

.result-card {
    background: var(--bg-card);
    border: 1px solid var(--border-dashed);
    position: relative;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: var(--text-muted);
    letter-spacing: 0.04em;
    text-transform: uppercase;
}

.result-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 2px;
}

.result-card.cat-animal::before { background: var(--sage); }
.result-card.cat-person::before { background: var(--blue); }
.result-card.cat-vehicle::before { background: var(--amber); }
.result-card.cat-empty::before { background: transparent; }

/* ── Demo Controls ─────────────────────────────────────────── */

.demo-controls {
    position: fixed;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.5rem;
    align-items: center;
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 0.75rem 1rem;
    z-index: 2000;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 90vw;
}

.demo-controls button {
    padding: 0.4rem 0.75rem;
    font-family: inherit;
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    background: var(--bg);
    border: 1px solid var(--border-light);
    cursor: pointer;
    transition: all 0.15s;
}

.demo-controls button:hover {
    background: var(--text);
    color: var(--bg);
}

.demo-controls button:disabled {
    opacity: 0.3;
    cursor: default;
    background: var(--bg);
    color: var(--text);
}

.demo-controls select {
    padding: 0.35rem 0.5rem;
    font-family: inherit;
    font-size: 0.7rem;
    border: 1px solid var(--border-light);
    background: var(--bg);
    cursor: pointer;
}

.demo-controls .demo-label {
    font-size: 0.6rem;
    font-weight: 500;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-muted);
}

.demo-controls .demo-sep {
    width: 1px;
    height: 20px;
    background: var(--border-light);
}

.layout-label {
    position: fixed;
    top: 1rem;
    right: 1rem;
    font-size: 0.65rem;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-muted);
    padding: 0.2rem 0.5rem;
    border: 1px solid var(--border-light);
    background: var(--bg-card);
    z-index: 100;
}

/* ── State indicator ──────────────────────────────────────── */

.state-indicator {
    position: fixed;
    top: 1rem;
    left: 1rem;
    font-size: 0.65rem;
    font-weight: 500;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-muted);
    padding: 0.2rem 0.5rem;
    border: 1px solid var(--border-light);
    background: var(--bg-card);
    z-index: 100;
}

    </style>
</head>
<body>
    <div class="layout-label">Idea 2c — all states</div>
    <div class="state-indicator" id="stateIndicator">State: idle</div>

    <main>
        <header>
            <h1>spoor</h1>
            <p class="tagline">Camera trap detection. On-device.</p>
        </header>

        <div class="command-bar">
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-inner" id="dropInner">
                    <div class="drop-zone-text" id="dropText">
                        <p class="drop-zone-primary">Drop images or folders here</p>
                        <p class="drop-zone-secondary">or click to select</p>
                    </div>
                </div>
                <div class="convergence-container" id="convergence"></div>
            </div>

            <div class="right-stack">
                <div class="controls-row">
                    <div class="control-group">
                        <span class="label-slash">/</span><span class="label toggle-label">Model</span>
                        <button class="toggle-btn">Quick (MDv6)</button>
                        <button class="toggle-btn active">Thorough (MDv5a)</button>
                    </div>
                    <div class="control-group">
                        <span class="label-slash">/</span><span class="label toggle-label">Confidence</span>
                        <input type="range" class="confidence-slider" min="5" max="95" value="20">
                        <span class="confidence-value">20%</span>
                    </div>
                </div>

                <div class="status-section" id="statusSection">
                    <div class="status-row">
                        <span class="status-text" id="statusText">Processing 0 of 200</span>
                        <button class="cancel-btn" id="cancelBtn">Cancel</button>
                    </div>
                    <div class="count-row"><span class="count-marker animal"></span> <span class="count-num" id="cAnimal">0</span> animal</div>
                    <div class="count-row"><span class="count-marker person"></span> <span class="count-num" id="cPerson">0</span> person</div>
                    <div class="count-row"><span class="count-marker vehicle"></span> <span class="count-num" id="cVehicle">0</span> vehicle</div>
                    <div class="count-row"><span class="count-marker empty"></span> <span class="count-num" id="cEmpty">0</span> empty</div>
                </div>
            </div>
        </div>

        <div class="results-header">
            <span class="results-summary" id="resultsSummary">Ready</span>
        </div>

        <div class="results-grid" id="resultsGrid">
        </div>
    </main>

    <div class="demo-controls">
        <span class="demo-label">Batch</span>
        <select id="batchSize">
            <option value="50">50</option>
            <option value="200" selected>200</option>
            <option value="2000">2,000</option>
            <option value="15000">15,000</option>
        </select>
        <button id="btnDetect">Detect</button>
        <button id="btnCancel" disabled>Cancel mid-run</button>
        <button id="btnComplete" disabled>Skip to done</button>
        <div class="demo-sep"></div>
        <button id="btnSpecies" disabled>Species</button>
        <button id="btnSpeciesDone" disabled>Species done</button>
        <div class="demo-sep"></div>
        <button id="btnReset" disabled>Reset</button>
    </div>

    <script>
    // ── Elements ──────────────────────────────────────────────
    const dropZone = document.getElementById('dropZone');
    const dropInner = document.getElementById('dropInner');
    const dropText = document.getElementById('dropText');
    const convergence = document.getElementById('convergence');
    const statusSection = document.getElementById('statusSection');
    const statusText = document.getElementById('statusText');
    const cancelBtn = document.getElementById('cancelBtn');
    const resultsSummary = document.getElementById('resultsSummary');
    const resultsGrid = document.getElementById('resultsGrid');
    const stateIndicator = document.getElementById('stateIndicator');

    const btnDetect = document.getElementById('btnDetect');
    const btnCancel = document.getElementById('btnCancel');
    const btnComplete = document.getElementById('btnComplete');
    const btnSpecies = document.getElementById('btnSpecies');
    const btnSpeciesDone = document.getElementById('btnSpeciesDone');
    const btnReset = document.getElementById('btnReset');
    const batchSelect = document.getElementById('batchSize');

    // ── Particles ─────────────────────────────────────────────
    const PARTICLE_COUNT = 28;
    for (let i = 0; i < PARTICLE_COUNT; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        const angle = Math.random() * Math.PI * 2;
        const dist = 35 + Math.random() * 25;
        const dur = 1.8 + Math.random() * 1.2;
        p.style.cssText = `
            --sx: ${Math.cos(angle) * dist}px;
            --sy: ${Math.sin(angle) * dist}px;
            --delay: ${Math.random() * 2.5}s;
            --dur: ${dur}s;
        `;
        convergence.appendChild(p);
    }

    // ── State ─────────────────────────────────────────────────
    let TOTAL = 200;
    let mockCategories = [];
    let processInterval = null;
    let processed = 0;
    let counts = { animal: 0, person: 0, vehicle: 0, empty: 0 };
    let currentState = 'idle'; // idle | detecting | done | species | species-done | cancelled

    function generateMockData(total) {
        const cats = [];
        for (let i = 0; i < total; i++) {
            const r = Math.random();
            if (r < 0.65) cats.push('animal');
            else if (r < 0.80) cats.push('empty');
            else if (r < 0.92) cats.push('person');
            else cats.push('vehicle');
        }
        return cats;
    }

    function setState(s) {
        currentState = s;
        stateIndicator.textContent = `State: ${s}`;
    }

    function updateCounts() {
        document.getElementById('cAnimal').textContent = counts.animal;
        document.getElementById('cPerson').textContent = counts.person;
        document.getElementById('cVehicle').textContent = counts.vehicle;
        document.getElementById('cEmpty').textContent = counts.empty;
    }

    function addPlaceholderCards(count) {
        const cats = ['cat-animal', 'cat-person', 'cat-vehicle', 'cat-empty'];
        for (let i = 0; i < count; i++) {
            const card = document.createElement('div');
            card.className = `result-card ${cats[i % cats.length]}`;
            card.textContent = 'placeholder';
            resultsGrid.appendChild(card);
        }
    }

    // ── Convergence helpers ───────────────────────────────────
    let convergenceTimers = [];

    function clearConvergenceTimers() {
        for (const id of convergenceTimers) clearTimeout(id);
        convergenceTimers = [];
    }

    function startConvergence() {
        // Cancel any in-flight stop sequence
        clearConvergenceTimers();

        // Snap to processing state immediately
        dropText.classList.add('hidden');
        convergence.classList.remove('fading');

        convergenceTimers.push(
            setTimeout(() => dropZone.classList.add('processing'), 100),
            setTimeout(() => {
                dropInner.classList.add('pulsing');
                convergence.classList.add('active');
            }, 700)
        );
    }

    function stopConvergence() {
        clearConvergenceTimers();

        dropInner.classList.remove('pulsing');
        convergence.classList.add('fading');

        convergenceTimers.push(
            setTimeout(() => {
                convergence.classList.remove('active', 'fading');
                dropZone.classList.remove('processing');
                convergenceTimers.push(
                    setTimeout(() => dropText.classList.remove('hidden'), 650)
                );
            }, 450)
        );
    }

    // ── Detect ────────────────────────────────────────────────
    btnDetect.addEventListener('click', () => {
        TOTAL = parseInt(batchSelect.value);
        mockCategories = generateMockData(TOTAL);

        setState('detecting');
        btnDetect.disabled = true;
        btnCancel.disabled = false;
        btnComplete.disabled = false;
        batchSelect.disabled = true;

        cancelBtn.classList.remove('hidden');
        statusSection.classList.add('visible');
        startConvergence();

        processed = 0;
        counts = { animal: 0, person: 0, vehicle: 0, empty: 0 };
        statusText.textContent = `Processing 1 of ${TOTAL}`;
        updateCounts();
        resultsSummary.textContent = `0 of ${TOTAL} images`;

        processInterval = setInterval(() => {
            if (processed >= TOTAL) {
                finishDetection();
                return;
            }
            const cat = mockCategories[processed];
            counts[cat]++;
            processed++;
            statusText.textContent = processed < TOTAL
                ? `Processing ${processed + 1} of ${TOTAL}`
                : `Processing ${processed} of ${TOTAL}`;
            updateCounts();
            resultsSummary.textContent = `${processed} of ${TOTAL} images`;
        }, 80);
    });

    // ── Detection complete ────────────────────────────────────
    function finishDetection() {
        clearInterval(processInterval);
        processInterval = null;
        processed = TOTAL;
        updateCounts();

        setState('done');
        statusText.textContent = 'Done';
        cancelBtn.classList.add('hidden');
        resultsSummary.textContent = `${TOTAL} images \u00b7 ${counts.animal} animal${counts.animal !== 1 ? 's' : ''}`;

        stopConvergence();
        addPlaceholderCards(8);

        btnCancel.disabled = true;
        btnComplete.disabled = true;
        btnSpecies.disabled = false;
        btnReset.disabled = false;
    }

    btnComplete.addEventListener('click', () => {
        // Fast-forward: fill remaining counts
        while (processed < TOTAL) {
            const cat = mockCategories[processed];
            counts[cat]++;
            processed++;
        }
        finishDetection();
    });

    // ── Cancel mid-run ────────────────────────────────────────
    btnCancel.addEventListener('click', () => {
        clearInterval(processInterval);
        processInterval = null;

        const skipped = TOTAL - processed;
        setState('cancelled');
        statusText.textContent = `Cancelled \u2014 ${skipped} image${skipped !== 1 ? 's' : ''} skipped`;
        cancelBtn.classList.add('hidden');
        resultsSummary.textContent = `${processed} of ${TOTAL} images (cancelled)`;

        stopConvergence();
        if (processed > 0) addPlaceholderCards(4);

        btnCancel.disabled = true;
        btnComplete.disabled = true;
        btnSpecies.disabled = counts.animal > 0 ? false : true;
        btnReset.disabled = false;
    });

    // ── Species identification ────────────────────────────────
    let speciesProcessed = 0;
    let speciesTotal = 0;

    btnSpecies.addEventListener('click', () => {
        speciesTotal = counts.animal;
        speciesProcessed = 0;

        setState('species');
        statusText.textContent = `Identifying species 1 of ${speciesTotal}`;
        cancelBtn.classList.remove('hidden');
        // Counts stay as they are — detection counts don't change during species

        startConvergence();

        btnSpecies.disabled = true;
        btnSpeciesDone.disabled = false;
        btnReset.disabled = true;

        processInterval = setInterval(() => {
            if (speciesProcessed >= speciesTotal) {
                finishSpecies();
                return;
            }
            speciesProcessed++;
            statusText.textContent = speciesProcessed < speciesTotal
                ? `Identifying species ${speciesProcessed + 1} of ${speciesTotal}`
                : `Identifying species ${speciesProcessed} of ${speciesTotal}`;
        }, 120);
    });

    function finishSpecies() {
        clearInterval(processInterval);
        processInterval = null;
        speciesProcessed = speciesTotal;

        setState('species-done');
        statusText.textContent = 'Done';
        cancelBtn.classList.add('hidden');
        resultsSummary.textContent = `${processed} images \u00b7 ${counts.animal} animals \u00b7 ${speciesTotal} species identified`;

        stopConvergence();

        btnSpeciesDone.disabled = true;
        btnReset.disabled = false;
    }

    btnSpeciesDone.addEventListener('click', () => {
        speciesProcessed = speciesTotal;
        finishSpecies();
    });

    // ── Reset ─────────────────────────────────────────────────
    btnReset.addEventListener('click', () => {
        clearInterval(processInterval);
        processInterval = null;
        clearConvergenceTimers();

        setState('idle');
        processed = 0;
        counts = { animal: 0, person: 0, vehicle: 0, empty: 0 };
        speciesProcessed = 0;
        speciesTotal = 0;

        statusSection.classList.remove('visible');
        cancelBtn.classList.add('hidden');
        resultsSummary.textContent = 'Ready';
        resultsGrid.innerHTML = '';

        dropZone.classList.remove('processing');
        dropInner.classList.remove('pulsing');
        convergence.classList.remove('active', 'fading');
        dropText.classList.remove('hidden');

        btnDetect.disabled = false;
        btnCancel.disabled = true;
        btnComplete.disabled = true;
        btnSpecies.disabled = true;
        btnSpeciesDone.disabled = true;
        btnReset.disabled = true;
        batchSelect.disabled = false;
    });

    // ── Toggle buttons (cosmetic) ─────────────────────────────
    document.querySelectorAll('.control-group').forEach(group => {
        const buttons = group.querySelectorAll('.toggle-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
    });
    const slider = document.querySelector('.confidence-slider');
    const val = document.querySelector('.confidence-value');
    if (slider && val) {
        slider.addEventListener('input', () => val.textContent = slider.value + '%');
    }
    </script>
</body>
</html>
